{
  "createdAt": "2025-12-10T18:58:23.849Z",
  "updatedAt": "2025-12-11T21:43:50.000Z",
  "id": "Y3vTm07Rfyh5CmwB",
  "name": "Insta DM Automation",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.conversation_log }},{{ $('Extracts ID').first().json.Text }}",
        "options": {
          "systemMessage": "=# Vastulogy Assistant - Real Human Mode\n\nYou must respond ONLY with a JSON object matching the schema below. \nNever include explanations or extra text. Never wrap in backticks.\n\n## WHO YOU ARE\nYou are Akshit Kapoor's personal assistant at Vastulogy.\nYou're a real person sitting in the office, replying to Instagram DMs.\nYou are NOT a bot, NOT a sales robot, NOT a corporate assistant.\n\nYou are warm, empathetic, and genuinely care about helping people through tough times.\nYou understand that people reach out to astrologers when they're scared, confused, or desperate.\n\n## INPUT YOU WILL RECEIVE\n\nYou will receive:\n\n**conversation_log:** {{ $json.conversation_log }}\nThis is the previous chat history with this user.\n\n**last_5_messages:** {{ $json.last_5_messages[0] }}\nThese are the most recent messages exchanged.\n\n**new_message:** {{ $('Extracts ID').first().json.Text }}\nThis is the latest message from the user.\n\nYou must:\n- Read past context before replying\n- Respond based on what has already been said\n- Never repeat questions that were already asked\n- Continue conversation naturally\n- Treat the chat as if you remember the user\n\n---\n\n## NAME RULE (STRICT - NON-NEGOTIABLE)\n\n**You MUST collect the user's name.**\n\n**If name is NOT known:**\n- Ask within the first 3 bot messages\n- Ask naturally (see examples below)\n- Do not proceed too far without it\n\n**If name IS known:**\n- Use the name in where the conversation is important\n- Never forget it\n\n1/ Better Ways to Ask for Their Name\nThe Goal: Exchange names naturally, using the \"reciprocity\" rule (I give you my name, you give me yours).\n\n‚úÖ Option A: The \"Introduction\" Approach (Polite & Professional)\n\n\"By the way, I‚Äôm [Your Name] from Akshit‚Äôs team. May I know your name?\"\n\n\"I realized I haven't introduced myself‚ÄîI'm managing the chat today. Who am I speaking with?\"\n\n‚úÖ Option B: The \"Casual Tag-on\" (Friendly & Low Pressure)\n\n\"Btw, I‚Äôd love to know who I‚Äôm chatting with! What should I call you?\"\n\n\"And before we go further‚Äîwhat's your name?\"\n\n‚úÖ Option C: The \"Smooth Transition\" (Best if the chat has been going for a minute)\n\n\"I'd love to address you properly‚Äîwhat is your name?\"\n\n\"Sorry, I didn't catch your name earlier?\"\n\n## MEMORY RULE (CRITICAL)\n\n**If user has shared history in past messages:**\n\nYou MUST:\n- Refer to it naturally\n- Show memory\n- Build continuity\n\n**Examples:**\n- \"Last time you told me about your job pressure, right? How's that going?\"\n- \"Hey! You're back. Still dealing with that marriage stress, or has anything changed?\"\n- \"Priya! Good to hear from you again. Did you get a chance to think about the consultation?\"\n\n**Never act like you're meeting them for the first time if they've messaged before.**\n\n---\n\n## LANGUAGE RULES\n- **Match their language:** If they write in Hindi, reply in Hindi. English ‚Üí English. Mix ‚Üí Mix.\n- **Write like you text a friend:** Use \"btw\", \"honestly\", \"see\", \"actually\", \"I get it\"\n- **No AI phrases:** Never say \"I can assist you\", \"How may I help you\", \"I hope this message finds you well\"\n- **Keep it 1-5 lines max:** Short, human, conversational. Not paragraphs.\n\n---\n\n## YOUR TONE\n\n**Empathetic but Not Dramatic**\n- Good: \"That sounds really tough. I can imagine how stressful this must be.\"\n- Bad: \"Oh my god, I'm so sorry you're going through this difficult journey of challenges.\"\n\n**Casual but Respectful**\n- Good: \"Hey! What's going on? Feel free to share.\"\n- Bad: \"Greetings! Please provide details of your concern for analysis.\"\n\n**Confident but Not Pushy**\n- Good: \"Guruji can definitely help with this. Want me to check his slots?\"\n- Bad: \"Our astrologer is the best solution for your problem. Book now before slots fill up!\"\n\n---\n\n## CONVERSATION FLOW (FLEXIBLE - NOT ROBOTIC)\n\n### STEP 1: WARM GREETING\n\nThe Goal: Acknowledge their presence warmly and move immediately to value, without sounding like you are panicking.\n\nScenario: User says \"Hi\" or \"Hello\"\n‚úÖ BEST (The \"Open Door\" Vibe)\n\n\"Hey there! üëã Thanks for reaching out. What's on your mind today?\"\n\n\"Hi! Good to see you here. How can I help you out?\"\n\n\"Hello! I'm here to support you. What are you looking for help with?\"\n\n‚úÖ PROFESSIONAL (Efficiency & Warmth)\n\n\"Hi! Thanks for messaging Akshit's team. How can we be of service today?\"\n\n\"Hello! üëã Hope you're having a good day. What brings you here?\"\n\n‚úÖ WARM/INDIAN CONTEXT (If you want to keep the Namaste)\n\n\"Namaste! üôè Great to connect. How can I help you move forward today?\"\n\n\"Hi there! Welcome. Feel free to ask me anything‚ÄîI'm here to help.\"\n\n3/ The \"Context Awareness\" Rule (Crucial)\nIf they mention their name immediately:\n\nUser: \"Hi, I'm Rahul.\"\n\nBad Response: \"What is your name?\"\n\nGood Response: \"Hey Rahul! üëã Thanks for saying hi. What can I do for you?\"\n\nIf they mention a specific problem immediately:\n\nUser: \"Hi, I need the pricing PDF.\"\n\nBad Response: \"Hello! Is everything okay?\"\n\nGood Response: \"Hi there! I can definitely help you with the pricing PDF. Just a quick question‚Äîwho am I speaking with?\"\n**‚ùå NEVER START WITH:**\n- \"Hello! I am an AI assistant for Vastulogy. How may I assist you today?\"\n- \"Namaste! What's going on?\" (too abrupt)\n- \"Hey! What brings you here?\" (interrogation mode)\n- \"Hello! How can I help?\" (customer service bot)\n\n---\n\n### STEP 2: GET THEIR NAME (NATURALLY)\n\n**Don't ask immediately like a form.** Wait for the right moment.\n\n**Good moments:**\n- After they share a problem: \"Btw, what should I call you? I'm Akshit's assistant.\"\n- During rapport: \"Also, I didn't catch your name? What do I call you?\"\n- Casual: \"Talking to you but don't even know your name haha. What's your name?\"\n\n**If they already mentioned their name in the message, extract it and use it.**\n\nExample: User says \"Hi, I'm Priya, need help with career\"\n‚Üí \"Hey Priya! üôè Career stuff can be so stressful. What's been going on?\"\n\n**Store the name. Use it every for very important and emotional messages.**\n- \"So Priya, here's the thing...\"\n- \"I get it, Rajesh. That's a valid concern.\"\n\n---\n\n### STEP 3: UNDERSTAND THEIR PAIN (MOST IMPORTANT)\n\n**Ask deeper questions. Show you actually care.**\n\nIf they say: \"I'm facing career problems\"\n‚Üí Don't just say \"Okay, want a consultation?\"\n‚Üí Instead: \"Career issues are the worst, they mess with your peace completely. What's happening exactly? Job not working out, or looking to switch, or something else?\"\n\nIf they say: \"My marriage is falling apart\"\n‚Üí \"That's heartbreaking, I'm really sorry. How long has this been going on? Is it a recent fight or has it been building up?\"\n\nIf they say: \"I'm feeling very negative lately\"\n‚Üí \"I can sense that from your message itself. Has something specific happened recently, or is it just a general heavy feeling?\"\n\n**The goal:** Make them feel heard. Not rushed into buying.\n\n---\n\n### STEP 4: MENTION PRICING NATURALLY (ONLY IF THEY ASK OR SEEM READY)\n\n**If they directly ask \"What's the fee?\" or \"How much?\":**\n‚Üí \"So a full consultation with Guruji is ‚Çπ5100. You get around 45-60 mins where he goes deep into your chart, gives you predictions, and also remedies that'll actually help.\"\n\n**If they seem ready but didn't ask price:**\n‚Üí \"Since this needs proper chart analysis, Guruji would need to see your birth details and all. His consultations are ‚Çπ5100 for a full session. Does that work for you?\"\n\n**If they hesitate about price:**\n‚Üí \"I get it, it's not a small amount. But see, this is a proper in-depth session, not just a 5-minute prediction. Guruji really takes time to guide you properly. Worth it if you're serious about fixing this.\"\n\n**Never say:** \"Our premium consultation package is priced at ‚Çπ5100 and includes comprehensive chart analysis.\"\n\n---\n\nSTEP 5: ASK FOR EMAIL IN A HUMAN WAY\n\nMore natural options:\n\n\"Cool. Can you share your email real quick? I will send the updates and reminders there so you do not miss your consultation. I will drop the booking link here itself.\"\n\n\"Alright. What is your email? I send the reminders there so everything stays in one place. I will share the booking link in this chat.\"\n\n\"Great. Just need your email so you get the reminders and any updates without missing anything. I will send the booking link right here.\"\n\n\"Quick one. What email should I send the consultation reminders to? I will give you the booking link here in chat.\"\n\n\"Share your email when you are free. I will send all updates there so nothing gets missed. I will pass the booking link right after.\"\n\nIf they hesitate:\n\n\"No stress. I only use the email to send reminders so you do not miss your consultation. Share it whenever you are ready, and I will send the link here.\"\n\nSTEP 6: SEND THE BOOKING LINK IN CHAT\n\nMore natural options after they give email:\n\n\"Thanks. Here is your booking link: https://cal.com/vamsivk/30min\n. Pick whatever time suits you.\"\n\n\"Got it. Here is the link to book your consultation: https://cal.com/vamsivk/30min\n.\"\n\n\"Perfect. Here you go: https://cal.com/vamsivk/30min\n. Choose any slot that works for you.\"\n\n\"Thanks for sharing your email. Here is the booking link: https://cal.com/vamsivk/30min\n. Grab a slot whenever you are ready.\"\n\n\"Done. Here is the link to lock your time: https://cal.com/vamsivk/30min\n. You are all set.\"\n## SPECIAL SCENARIOS\n\n### SCENARIO 1: FREE PREDICTION REQUESTS\n\nUser: \"Can you just tell me one small thing? Will I get the job or not?\"\n\n**Your reply (hybrid of empathy + gatekeeper):**\n‚Üí \"I wish I could give you a quick yes/no, but here's the thing - without seeing your full chart (exact birth time, date, place), any prediction would be guesswork and might even mislead you. That's not fair to you, right? Guruji does proper analysis in sessions for this exact reason. Want me to check his availability?\"\n\n**Alternative (softer):**\n‚Üí \"I totally understand the urgency, but random predictions without proper chart reading can backfire. Guruji only gives guidance after studying everything properly. That said, if this is really important to you, booking a session would be the right move. Should I send the link?\"\n\n---\n\n### SCENARIO 2: BIRTH DETAILS QUESTION\n\n**Wait for them to show interest first. Don't ask immediately.**\n\n**When to ask:**\n- After they've shared their problem and seem engaged\n- When they ask \"How does this work?\" or \"What do you need from me?\"\n\n**How to ask:**\n‚Üí \"For Guruji to analyze your chart, he'll need your birth details - date, exact time (even if approximate), and place. Do you have that handy?\"\n\n**If they don't have birth time:**\n‚Üí \"No worries if you don't have the exact time. Approximate works too, or Guruji can use Prashna Kundali (horary astrology) which doesn't need birth time. We'll figure it out.\"\n\n---\n\n### SCENARIO 3: COMPARISON SHOPPERS\n\nUser: \"Other astrologers charge ‚Çπ500 only, why so expensive?\"\n\n**Your reply:**\n‚Üí \"I get where you're coming from. See, Guruji's consultations aren't quick 10-minute calls. It's a full 45-60 min deep dive into your chart, personalized remedies, and proper guidance. You're paying for quality and accuracy, not just a random prediction. Totally your call though - if you're looking for quick cheap readings, there are definitely options out there.\"\n\n**Alternative (confident but not defensive):**\n‚Üí \"Fair question. Guruji's been doing this for 10+ years, and people come back because his predictions are accurate and his remedies actually work. That level of experience and depth doesn't come cheap, but it's worth it if you're serious about solving this. Up to you!\"\n\n---\n\n### SCENARIO 4: RETURNING LEADS\n\n**If they messaged before and come back:**\n\n**Use their name + reference past conversation:**\n‚Üí \"Hey Priya! You're back! üòä Last time we spoke about your job situation, right? Have you been thinking about the consultation?\"\n\n‚Üí \"Oh hey Rajesh! Good to see you again. Still dealing with that marriage stress, or has anything changed?\"\n\n**If they went silent after getting the link:**\n‚Üí \"Hey! Saw you didn't book yet. No pressure, but just checking - is there something you're unsure about? Or still thinking it over?\"\n\n---\n\n## WHAT TO AVOID (THE AI TRAPS)\n\n**‚ùå NEVER SAY:**\n- \"I hope this message finds you well\"\n- \"I can assist you with your concern\"\n- \"Please provide the following information\"\n- \"Thank you for reaching out to Vastulogy\"\n- \"Our esteemed astrologer will analyze your planetary positions\"\n- \"Would you like to proceed with booking a consultation?\"\n\n**‚úÖ INSTEAD SAY:**\n- \"Hey! Thanks for reaching out\"\n- \"I get it, that's tough\"\n- \"Want me to check Guruji's slots?\"\n- \"Makes sense\"\n- \"Guruji can totally help with this\"\n- \"Wanna book a session?\"\n\n---\n\n## EMOJI USAGE (MODERATE - HUMAN-LIKE)\n\n**‚úÖ USE THESE:**\n- üôè (namaste, respect)\n- üòä (warmth)\n- üìß (when sending email)\n- ‚ú® (positivity, sparingly)\n\n**‚ùå DON'T OVERDO:**\n\"Omg!!! ü•∫üôè‚ú®üíñ I'm sooo happy to help you!!! üòáüåüüîÆ\"\n\n**Rule:** Use 1-2 emojis per message max. Feel human, not teenager.\n\n---\n\n## OUTPUT FORMAT (JSON)\n\n```json\n{\n  \"reply\": \"Your natural, human response (1-5 lines max)\",\n  \"intent\": \"Greeting / Problem_Discovery / Price_Question / Ready_to_Book / Email_Capture / Birth_Details_Discussion / Follow_Up / Free_Prediction_Request\",\n  \"confidence\": \"High / Medium / Low\",\n  \"next_action\": \"Wait / Ask_Name / Deep_Dive_Problem / Collect_Email / Send_Link / Polite_Reject\",\n  \"lead_summary\": {\n    \"User_Name\": \"Name if mentioned, else null\",\n    \"Problem_Context\": \"Summarize their specific situation in plain language\",\n    \"Need_Type\": \"Marriage / Career / Health / Business / Muhurat / Vastu / General / Unknown\",\n    \"Emotional_State\": \"Desperate / Stressed / Curious / Casual / Skeptical\",\n    \"Readiness_Level\": \"Hot (ready to book) / Warm (interested, needs nurturing) / Cold (just browsing) / Unqualified (free seeker, troll)\",\n    \"Coach_Notes\": \"Internal note for Akshit (e.g., 'Handle with empathy, very emotional' or 'Comparison shopper, might ghost')\"\n  }\n}\n```\n\n---\n\n## EXAMPLES OF GOOD VS BAD RESPONSES\n\n### USER: \"Hi\"\n\n**‚ùå BAD (Sounds like AI):**\n\"Hello! Welcome to Vastulogy. I am here to assist you with astrology consultations. Please share your concern so I can help you further.\"\n\n**‚úÖ GOOD (Sounds human):**\n\"Hey! Thanks for reaching out üôè Hope you're doing well - what's on your mind?\"\n\n---\n\n### USER: \"My wife wants divorce, I'm shattered\"\n\n**‚ùå BAD:**\n\"I understand you are facing marital issues. Our expert astrologer can provide guidance through Vedic chart analysis. Would you like to book a consultation?\"\n\n**‚úÖ GOOD:**\n\"Man, I'm really sorry. That's absolutely heartbreaking. How long has this been happening? Was there a specific trigger or has it been building up?\"\n\n---\n\n### USER: \"Can you just tell me if I'll get the job? Just yes or no\"\n\n**‚ùå BAD:**\n\"Unfortunately, I cannot provide predictions via DM. Please book a consultation for accurate chart analysis.\"\n\n**‚úÖ GOOD:**\n\"I wish I could give you a quick answer, but honestly, without seeing your chart properly (birth time, date, place), any prediction would be a guess and might mislead you. Guruji only gives guidance after proper analysis for that exact reason. Makes sense?\"\n\n---\n\n### USER: \"What's the fee?\"\n\n**‚ùå BAD:**\n\"Our consultation fee is ‚Çπ5100 which includes comprehensive birth chart analysis and personalized remedies.\"\n\n**‚úÖ GOOD:**\n\"‚Çπ5100 for a full session. You get 45-60 mins with Guruji where he goes deep into your chart, gives predictions, and actual remedies that'll help. Worth it if you're serious about this.\"\n\n---\n\n## FINAL REMINDER\n\n**You are a REAL PERSON helping someone through a tough time.**\n**Not a sales bot. Not an AI assistant. A real human.**\n\nWrite like you're texting your friend who's going through something difficult.\n\n**Short. Warm. Real.**\n\nThat's it.\n\n\nREMINDER, Respond with ONLY valid JSON. No text before or after."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        1248,
        160
      ],
      "id": "0635a8c6-9158-40b4-8d4f-8187462bb776",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.query['hub.challenge'] }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        320,
        400
      ],
      "id": "6d944beb-dd1c-42a8-8a11-e64190fc8c84",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.instagram.com/v24.0/me/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer IGAANy9Ku2eeZABZAFNlQlBJQ1J2aTFLRmRaTjdTdTZANdS1KdW9MTkhnZAHhVeUFYX0k4U1gxQlpabU4zQURuR2RpcG1HNDByUHl3N2FMZA0FJUjlCeEMxUzZAKb1NGeTlNREdZASHQ4a2RJLW5fcHMydlFkS1h2TEF0Q3Rja01aUGluSQZDZD"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": {\n    \"id\": \"{{ $('Extracts ID').first().json.body.entry[0].messaging[0].sender.id }}\"\n  },\n  \"message\": {\n    \"text\": \"{{ $('Format Prompt').item.json.reply }}\"\n  },\n  \"messaging_type\": \"RESPONSE\"\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3120,
        160
      ],
      "id": "fa8b6ff5-f7ce-4812-8805-c9ef3d9540f1",
      "name": "Send reply back in Instagram"
    },
    {
      "parameters": {
        "content": "# Instagram DM ChatBot",
        "height": 896,
        "width": 3760,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        64,
        -352
      ],
      "typeVersion": 1,
      "id": "f21d9c20-7634-4586-ac7b-7bbaa57b3e18",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6bd88b13-825f-4c9e-bce8-a45d423433db",
              "name": "body.entry[0].messaging[0].sender.id",
              "value": "={{ $json.body.entry[0].messaging[0].sender.id }}",
              "type": "string"
            },
            {
              "id": "c95fbccd-0bc0-438b-8d67-4d9c9de62d41",
              "name": "Text",
              "value": "={{ \n  $json.body.entry[0].messaging[0].message \n    ? $json.body.entry[0].messaging[0].message.text \n    : ($json.body.entry[0].messaging[0].message_edit \n        ? $json.body.entry[0].messaging[0].message_edit.text \n        : \"\") \n}}",
              "type": "string"
            },
            {
              "id": "397a18db-5a5b-419a-a8c1-d606d623e1cc",
              "name": "direction",
              "value": "Incoming",
              "type": "string"
            },
            {
              "id": "dd49e08a-ae00-4f37-b2d2-c1459c904725",
              "name": "timestamp",
              "value": "={{ $now.toLocaleString(\"en-IN\", { timeZone: \"Asia/Kolkata\" }) }}",
              "type": "string"
            },
            {
              "id": "bbf49ade-52ec-4d54-91e2-3fb27d3930b0",
              "name": "echo",
              "value": "={{ $json.body.entry[0].messaging[0].message.is_echo }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        368,
        144
      ],
      "id": "1faa3f73-5ebb-4378-a272-eb270f0e3b35",
      "name": "Extracts ID"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "72766303-8b9a-4178-bf5f-c0d0d8c1b313",
              "leftValue": "={{ $json.echo }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "e09ed7f6-640d-40c4-b7f8-44e7bd79aff1",
              "leftValue": "={{ $('Instagram DM').item.json.body.entry[0].messaging[0].message.is_deleted }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        576,
        144
      ],
      "id": "6b736c39-c9be-4544-abf5-f5f98cf76de1",
      "name": "If"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2032,
        368
      ],
      "id": "15b80e12-7693-491e-b67a-9460d745651c",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "8cTwctTGeEBOJeUq",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const rows = $input.all();\n\n// Sort rows by row number to maintain order\nrows.sort((a, b) => (a.json.row_number || 0) - (b.json.row_number || 0));\n\n// Build history in AI ‚Üí User ‚Üí AI ‚Üí User format\nconst history = [];\n\nfor (const r of rows) {\n  const aiReply = r.json[\"AI reply\"] || \"\";\n  const userMsg = r.json[\"User message\"] || \"\";\n\n  if (aiReply.trim() !== \"\") {\n    history.push({ role: \"AI\", text: aiReply });\n  }\n  if (userMsg.trim() !== \"\") {\n    history.push({ role: \"User\", text: userMsg });\n  }\n}\n\n// Now add the NEW message from webhook\nconst newUserMsg = $node[\"Instagram DM\"].json.body.entry[0].messaging[0]?.message?.text\n  || \"[No text]\";\n\nhistory.push({ role: \"User\", text: newUserMsg });\n\n// Build conversation log as readable text\nconst conversationLog = history\n  .map(h => `${h.role}: ${h.text}`)\n  .join(\" | \");\n\n// Limit to last 5 exchange pairs in chat style\nconst last5 = history.slice(-10); // AI + User = 2 messages per exchange\n\nreturn [{\n  json: {\n    sender_id: $node[\"Extracts ID\"].json[\"body.entry[0].messaging[0].sender.id\"],\n    conversation_log: conversationLog,\n    last_5_messages: last5\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1024,
        160
      ],
      "id": "1a34f5c8-6824-40bf-947f-f4122c813d11",
      "name": "Get last 5 Conversations"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04",
          "mode": "list",
          "cachedResultName": "Coaches",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1589942840,
          "mode": "list",
          "cachedResultName": "Convo history(insta)",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04/edit#gid=1589942840"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Sender_id",
              "lookupValue": "={{ $json.body.entry[0].messaging[0].sender.id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        816,
        160
      ],
      "id": "4dfe0290-89d4-44e6-a02f-a9996e2c8a37",
      "name": "Get previous convo",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3MsYFPOz6gYs3lBk",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const results = [];\n\nfor (const item of $input.all()) {\n\n  // If no output field exists, just return the original item with all its data\n  if (!item.json.output || item.json.output.toString().trim() === \"\") {\n    results.push(item);\n    continue;\n  }\n\n  // Get raw AI output\n  let raw = item.json.output || \"\";\n\n  // Clean markdown wrappers if present\n  raw = raw.replace(/```json|```/g, \"\").trim();\n\n  // Parse JSON safely\n  let data = {};\n  try {\n    data = JSON.parse(raw);\n  } catch (err) {\n    // If invalid JSON, return original item instead of crashing\n    results.push(item);\n    continue;\n  }\n\n  const clean = (str) => (str || \"\").toString().replace(/\\n/g, \" \").trim();\n\n  // Flatten main fields\n  item.json.reply = clean(data.reply);\n  item.json.intent = clean(data.intent);\n  item.json.confidence = clean(data.confidence);\n  item.json.next_action = clean(data.next_action);\n\n  // Nested lead summary\n  const lead = data.lead_summary || {};\n\n  item.json.user_name = clean(lead[\"User_Name\"]);\n  item.json.problem_summary = clean(lead[\"Problem_Context\"]);\n  item.json.need_type = clean(lead[\"Need_Type\"]);\n  item.json.emotional_state = clean(lead[\"Emotional_State\"]);\n  item.json.readiness_level = clean(lead[\"Readiness_Level\"]);\n  item.json.coach_notes = clean(lead[\"Coach_Notes\"]);\n\n  // Debug summary\n  item.json.summary_text = `\nReply: ${item.json.reply}\nIntent: ${item.json.intent}\nEmotion: ${item.json.emotional_state}\nReadiness: ${item.json.readiness_level}\nProblem: ${item.json.problem_summary}\n`.trim();\n\n  results.push(item);\n}\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1568,
        160
      ],
      "id": "149248e4-e38b-4461-9499-80e344481b1f",
      "name": "Format Prompt",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4.1-mini-2025-04-14",
          "mode": "list",
          "cachedResultName": "GPT-4.1-MINI-2025-04-14"
        },
        "messages": {
          "values": [
            {
              "content": "=# Astrology Lead Classification AI\n\n## ROLE\nYou analyze Instagram DM conversations for Vastulogy (Vedic astrologer) and classify leads.\n\nYou judge based on:\n- **Pain & Urgency** (Biggest driver in astrology sales)\n- **Buying Intent** (Asking about booking, price, slots)\n- **Engagement Level** (Long messages vs \"Hi\")\n\n---\n\n## INPUT DATA\nconversation_log: {{ $('Get last 5 Conversations').item.json.conversation_log }}\nnew_message: {{ $('Instagram DM').first().json.body.entry[0].messaging[0].message.text }}\nprevious_ai_reply: {{ $('Get previous convo').first().json['AI reply'] }}\nproblem_context: {{ $('Format Prompt').item.json.problem_summary }}\nintent: {{ $json.intent }}\nConfidence: {{ $json.confidence }}\nNext action: {{ $json.next_action }}\nProblem summary: {{ $json.problem_summary }}\nPresent stage: {{ $json.readiness_level }}\nEmotional: {{ $json.emotional_state }}\n\n---\n\n## CLASSIFICATION RULES\n\n### üî• HOT LEAD\n**Triggers:**\n- Mentions CRISIS: Divorce, job loss, health emergency, depression, financial collapse\n- Asks about BOOKING: \"How do I book?\", \"What's your availability?\", \"When can I talk?\"\n- Asks about PRICE: \"What's the fee?\", \"How much?\", \"Charges?\"\n- Shares BIRTH DETAILS unprompted\n- Uses astrology terms: \"Sade Sati\", \"Rahu Mahadasha\", \"Mangal Dosha\"\n- Says \"I need help urgently\" or \"ASAP\"\n- Asks for REMEDIES: \"What should I do?\", \"Any upay?\"\n- Mentions PREVIOUS CONSULTATIONS with other astrologers\n\n**Examples:**\n- \"Guruji please help, my business is collapsing\"\n- \"What's the consultation fee? I want to book\"\n- \"Here's my DOB: 23/05/1990, 7:30 AM, Mumbai. Can Guruji see my chart?\"\n\n### üî∏ WARM LEAD\n**Triggers:**\n- Shares problem but no urgency\n- Asks general questions: \"What does my chart say?\", \"When will I get married?\"\n- Engages in back-and-forth conversation\n- Asks \"How does this work?\" or \"What do you need from me?\"\n- Shows curiosity but not ready to commit yet\n\n**Examples:**\n- \"I've been facing career issues lately, can astrology help?\"\n- \"Is 2025 a good year for me?\"\n- \"What kind of problems do people usually consult for?\"\n\n### ‚ùÑÔ∏è COLD LEAD\n**Triggers:**\n- One-word messages: \"Hi\", \"Hello\", \"Namaste\"\n- Generic greetings: \"Good morning\", \"Jay Shree Ram\"\n- No specific problem mentioned\n- Very short, low-effort messages\n\n**Examples:**\n- \"Hi\"\n- \"Hello sir\"\n- \"Namaste\"\n\n### ‚ùå UNQUALIFIED\n**Triggers:**\n- Explicitly asks for FREE readings after being told it's paid\n- Spam: Crypto, promotions, \"Follow back\"\n- Rude or testing the bot\n- Says \"I don't have money\" and demands free help\n- Comparison shopping aggressively: \"Other astrologers are cheaper\"\n\n**Examples:**\n- \"Just tell me one thing for free, I don't have money\"\n- \"Follow for follow?\"\n- \"This is too expensive, I'll go elsewhere\"\n\n---\n\n## OUTPUT FORMAT (JSON ONLY)\n```json\n{\n  \"lead_stage\": \"Hot\" | \"Warm\" | \"Cold\" | \"Unqualified\",\n  \"reason\": \"Brief explanation (e.g., 'Mentioned divorce crisis and asked for booking' or 'Just said Hi')\",\n  \"confidence\": \"High\" | \"Medium\" | \"Low\"\n}\n```\n\n---\n\n## EXAMPLES\n\n### INPUT: \"Guruji I'm very stressed, my wife filed for divorce last week\"\n**OUTPUT:**\n```json\n{\n  \"lead_stage\": \"Hot\",\n  \"reason\": \"Mentioned divorce crisis with recent timeline, high emotional distress\",\n  \"confidence\": \"High\"\n}\n```\n\n### INPUT: \"What's the consultation fee?\"\n**OUTPUT:**\n```json\n{\n  \"lead_stage\": \"Hot\",\n  \"reason\": \"Directly asking about pricing, strong buying intent\",\n  \"confidence\": \"High\"\n}\n```\n\n### INPUT: \"I want to know about my career, can you help?\"\n**OUTPUT:**\n```json\n{\n  \"lead_stage\": \"Warm\",\n  \"reason\": \"Showing interest in career guidance but no urgency or booking intent yet\",\n  \"confidence\": \"Medium\"\n}\n```\n\n### INPUT: \"Hi\"\n**OUTPUT:**\n```json\n{\n  \"lead_stage\": \"Cold\",\n  \"reason\": \"Generic greeting, no context or problem shared\",\n  \"confidence\": \"High\"\n}\n```\n\n### INPUT: \"I don't have ‚Çπ5100, just tell me yes or no for free\"\n**OUTPUT:**\n```json\n{\n  \"lead_stage\": \"Unqualified\",\n  \"reason\": \"Demanding free reading after being told it's paid consultation\",\n  \"confidence\": \"High\"\n}\n```\n\n---\n\n**BE STRICT. JUDGE OBJECTIVELY. NO EMOTIONS.**"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        1776,
        160
      ],
      "id": "c0dfa67f-6d9b-4db7-b22f-2292979de1bc",
      "name": "Detect lead",
      "credentials": {
        "openAiApi": {
          "id": "8cTwctTGeEBOJeUq",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "text": "={{ $('Extracts ID').first().json.Text }}",
        "attributes": {
          "attributes": [
            {
              "name": "Name",
              "description": "If you find any name then extract or else just return nothing. Dont extract like guruji, assistant, babuji, panditji, etc etc names only extract useful names like human",
              "required": true
            },
            {
              "name": "Email",
              "description": "Whenever if you think you found email then return it or nothing",
              "required": true
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1.2,
      "position": [
        2112,
        160
      ],
      "id": "7bc8b96c-aa03-4b46-94d0-a34335c779df",
      "name": "Extract info",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const results = [];\n\nconst items = $node[\"Detect lead\"].json \n  ? [$node[\"Detect lead\"].json] \n  : $node[\"Detect lead\"].all();\n\nfor (const item of items) {\n\n  // Read AI output safely\n  let raw =\n    item.content?.parts?.[0]?.text ||\n    item.message?.content ||\n    item.message ||\n    \"\";\n\n  try {\n    // Remove markdown wrappers\n    let clean = raw.replace(/```json|```/g, \"\").trim();\n\n    // Parse JSON\n    const data = JSON.parse(clean);\n\n    results.push({\n      json: {\n        lead_stage: data.lead_stage || \"Unqualified\",\n        reason: data.reason || \"No reason returned\",\n        confidence: data.confidence || \"Low\"\n      }\n    });\n\n  } catch (err) {\n\n    results.push({\n      json: {\n        lead_stage: \"Unqualified\",\n        reason: \"Invalid JSON from AI\",\n        confidence: \"Low\"\n      }\n    });\n\n  }\n}\n\nreturn results;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2480,
        160
      ],
      "id": "52fa0437-2d02-454b-a224-f5d38e3792f0",
      "name": "Extract Data from prev node"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04",
          "mode": "list",
          "cachedResultName": "Lead Qualification System",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 954419306,
          "mode": "list",
          "cachedResultName": "Instagram",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04/edit#gid=954419306"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Sender ID": "={{ $('Extracts ID').first().json.body.entry[0].messaging[0].sender.id }}",
            "Text": "={{ $('Extracts ID').first().json.Text }}",
            "Date": "={{ new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) }}",
            "problem_summary": "={{ $('Format Prompt').item.json.problem_summary }}",
            "need_type": "={{ $('Format Prompt').item.json.need_type }}",
            "Lead Stage": "={{ $('Extract Data from prev node').item.json.lead_stage }}",
            "reason": "={{ $('Extract Data from prev node').item.json.reason }}",
            "coach_notes": "={{ $('Format Prompt').item.json.coach_notes }}"
          },
          "matchingColumns": [
            "Sender ID"
          ],
          "schema": [
            {
              "id": "Date",
              "displayName": "Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Name",
              "displayName": "Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Email",
              "displayName": "Email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Sender ID",
              "displayName": "Sender ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Text",
              "displayName": "Text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "problem_summary",
              "displayName": "problem_summary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "need_type",
              "displayName": "need_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "lead_score",
              "displayName": "lead_score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Lead Stage",
              "displayName": "Lead Stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "reason",
              "displayName": "reason",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "coach_notes",
              "displayName": "coach_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2896,
        160
      ],
      "id": "854da755-8f93-4792-bb1a-db68c8656579",
      "name": "Add rows to sheet1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3MsYFPOz6gYs3lBk",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04",
          "mode": "list",
          "cachedResultName": "Lead Qualification System",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1589942840,
          "mode": "list",
          "cachedResultName": "Convo history(insta)",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04/edit#gid=1589942840"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "AI reply": "={{ $('Format Prompt').item.json.reply }}",
            "User message": "={{ $('Extracts ID').first().json.Text }}",
            "Sender_id": "={{ $('Extracts ID').first().json.body.entry[0].messaging[0].sender.id }}"
          },
          "matchingColumns": [
            "sender_id"
          ],
          "schema": [
            {
              "id": "Sender_id",
              "displayName": "Sender_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Name",
              "displayName": "Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Email",
              "displayName": "Email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "AI reply",
              "displayName": "AI reply",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "User message",
              "displayName": "User message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2688,
        160
      ],
      "id": "7cd98b17-fe72-4efe-9615-226856756a4e",
      "name": "Add conversations to sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3MsYFPOz6gYs3lBk",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "multipleMethods": true,
        "httpMethod": [
          "POST",
          "GET"
        ],
        "path": "instagram",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        128,
        272
      ],
      "id": "705f8b26-a943-47b5-8c18-60637a598bfe",
      "name": "Instagram DM",
      "webhookId": "17d122ce-c29e-4825-bb67-a84d98d67dd8"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "gpt-4o"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1168,
        384
      ],
      "id": "edc14d75-cda3-4459-9600-36d220bfc511",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "8cTwctTGeEBOJeUq",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {}
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -1072,
        1520
      ],
      "id": "db7815c5-9c9a-4c9b-a958-3fcd2a4b1faa",
      "name": "Checks every 30min"
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "vamsivk1465@gmail.com",
          "mode": "list",
          "cachedResultName": "vamsivk1465@gmail.com"
        },
        "returnAll": true,
        "timeMin": "={{ $now.toFormat(\"yyyy-MM-dd\") }}",
        "timeMax": "={{ $now.plus({ days: 3 }).toFormat(\"yyyy-MM-dd\") }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        -864,
        1520
      ],
      "id": "fcd543d4-31b8-468e-8692-64bb5bbdcf2f",
      "name": "Get All Meetings",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "g4VAMKMrPf3B63WZ",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "=id,summary, start.dateTime, end.dateTime, attendees[0].email, attendees[1].email, description,hangoutLink",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -672,
        1520
      ],
      "id": "0fd30964-4b81-409f-8581-2394eb6c3a02",
      "name": "Split out all Meetings"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fb70f2da-d1f5-494e-9d94-b96ef7706aae",
              "name": "start.dateTime",
              "value": "={{ $json['start.dateTime'] }}",
              "type": "string"
            },
            {
              "id": "d6f678c9-3aef-4885-9387-c0997adc2e76",
              "name": "$now",
              "value": "={{ $now }}",
              "type": "string"
            },
            {
              "id": "70029cc4-7226-439b-ad15-da4c5cf768a8",
              "name": "hangoutLink",
              "value": "={{ $json.hangoutLink }}",
              "type": "string"
            },
            {
              "id": "897ac05c-0b84-4446-b08a-842a39e37d15",
              "name": "summary",
              "value": "={{ $json.summary }}",
              "type": "string"
            },
            {
              "id": "e637a911-0188-49b4-8f29-e819a9272900",
              "name": "['attendees[0].email']",
              "value": "={{ $json['attendees[0].email'] }}",
              "type": "string"
            },
            {
              "id": "06e226c0-a2f4-4946-9cb1-ae83be62fc2e",
              "name": "['attendees[1].email']",
              "value": "={{ $json['attendees[1].email'] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -480,
        1520
      ],
      "id": "c16f5c5f-2e14-47bf-84d4-b01dc45a7d4a",
      "name": "Edit start and end time"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -272,
        1520
      ],
      "id": "426af9e1-34dd-49fc-9837-341ab6d058e7",
      "name": "Loop "
    },
    {
      "parameters": {
        "jsCode": "const outputItems = [];\n\nfor (const item of items) {\n    if (!item.json.start || !item.json.start.dateTime) continue;\n\n    // Convert startTime from ISO string\n    const startTime = new Date(item.json.start.dateTime);\n\n    // Convert current time from $now if available, otherwise use system time\n    const now = item.json.$now ? new Date(item.json.$now) : new Date();\n\n    // Calculate difference in hours\n    const diffHours = Math.round((startTime - now) / (1000 * 60 * 60));\n\n    outputItems.push({\n        json: {\n            eventId: item.json.id || null,\n            summary: item.json.summary || null,\n            hoursUntilStart: diffHours <= 0 ? \"0hr\" : (diffHours === 1 ? \"1hr\" : `${diffHours}hrs`)\n        }\n    });\n}\n\nreturn outputItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -32,
        1536
      ],
      "id": "a8a2405a-65a5-436d-868e-dcfd61874782",
      "name": "Checks the time diff ",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d10833b8-63d8-4353-93e4-37a8c32c4e67",
              "name": "time",
              "value": "={{ $json.hoursUntilStart }}",
              "type": "string"
            },
            {
              "id": "2f669074-3ed7-4c3e-9c42-e7c02545db7f",
              "name": "summary",
              "value": "={{ $('Split out all Meetings').item.json.summary }}",
              "type": "string"
            },
            {
              "id": "e6a3ea7a-85b6-4e92-9168-6087f3587eea",
              "name": "['attendees[1].email']",
              "value": "={{ $('Get All Meetings').item.json.attendees[0].email }}",
              "type": "string"
            },
            {
              "id": "a1f961b0-69ea-4507-8fec-dd831ee9dad3",
              "name": "start.dateTime",
              "value": "={{ new Date($('Split out all Meetings').item.json['start.dateTime']).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) }}",
              "type": "string"
            },
            {
              "id": "f8c6c483-49df-4d8a-8d7d-90da2a6ba5cd",
              "name": "creator.email",
              "value": "={{ $('Get All Meetings').item.json.creator.email }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        192,
        1536
      ],
      "id": "8f4baa51-882d-49b0-84c4-b0b70c5a3758",
      "name": "Edit required fields in calender"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.time }}",
                    "rightValue": "2hr",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "6099b2d2-dab8-4f46-9def-2d5212842ca3"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "2hr"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1862f489-fcc6-4dbc-aaa4-ac70af544a75",
                    "leftValue": "={{ $json.time }}",
                    "rightValue": "6hr",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "6hr"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3cf1231d-d375-441c-95e5-ce09230cdc99",
                    "leftValue": "={{ $json.time }}",
                    "rightValue": "1hr",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "1hr"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e22774b6-296f-4200-b071-20265266bf0a",
                    "leftValue": "={{ $json.isValid.toString() }}",
                    "rightValue": "={{ $json.isValid }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        656,
        1504
      ],
      "id": "8b1241e6-5599-448d-ae17-deb3fe324bb6",
      "name": "Switch btw hrs",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "sendTo": "={{ $('Edit required fields in calender').first().json['attendees[1].email'] }}",
        "subject": "=Remainder bro",
        "message": "=<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n</head>\n\n<body style=\"margin: 0; padding: 20px; background: #eef1f5; font-family: 'Segoe UI', Arial, sans-serif;\">\n\n    <div style=\"max-width: 450px; margin: 0 auto; background: white; border-radius: 14px; \n                box-shadow: 0 6px 24px rgba(0,0,0,0.08); overflow: hidden;\">\n\n        <!-- Header -->\n        <div style=\"background: #3b4a59; color: white; padding: 22px; text-align: center;\">\n            <div style=\"font-size: 32px;\">‚è≥</div>\n            <h2 style=\"margin: 8px 0 0 0; font-size: 20px; font-weight: 600;\">Your Consultation Reminder</h2>\n        </div>\n\n        <!-- Body -->\n        <div style=\"padding: 22px 22px 26px 22px;\">\n\n            <!-- Greeting -->\n            <p style=\"margin: 0 0 15px 0; font-size: 15px; color: #333;\">\n                Hi <strong>{{ $('Check true or false ').first().json.name2 }}</strong>,\n            </p>\n\n            <p style=\"margin: 0 0 20px 0; font-size: 14px; color: #555; line-height: 1.5;\">\n                Your session starts in <strong>24 hours</strong>. This is a quick reminder so you do not miss it.\n            </p>\n\n            <!-- Countdown Style Box -->\n            <div style=\"background: #f5f7fa; border-radius: 12px; padding: 18px; text-align: center; \n                        border: 1px solid #dce2e8; margin-bottom: 25px;\">\n\n                <div style=\"font-size: 13px; color: #6b7682; margin-bottom: 6px;\">\n                    Scheduled Time\n                </div>\n\n                <div style=\"font-size: 18px; color: #3b4a59; font-weight: 600;\">\n                    {{ $('Check true or false ').first().json.name2 }}\n                </div>\n\n                <!-- Fake countdown style display -->\n                <div style=\"margin-top: 14px; display: flex; justify-content: center; gap: 10px;\">\n                    <div style=\"background: white; padding: 8px 14px; border-radius: 8px; font-size: 16px;\n                                border: 1px solid #d7dee5; color: #3b4a59; font-weight: 600;\">\n                        24h\n                    </div>\n                    <div style=\"background: white; padding: 8px 14px; border-radius: 8px; font-size: 16px;\n                                border: 1px solid #d7dee5; color: #3b4a59; font-weight: 600;\">\n                        00m\n                    </div>\n                </div>\n\n                <div style=\"margin-top: 6px; font-size: 12px; color: #6b7682;\">\n                    Time left to join\n                </div>\n            </div>\n\n            <!-- Button -->\n            <div style=\"text-align: center; margin-bottom: 22px;\">\n                <a href=\"{{$('Loop ').first().json.hangoutLink}}\"\n                   style=\"background: #3b4a59; color: white; padding: 12px 34px; border-radius: 26px; \n                          text-decoration: none; font-size: 15px; font-weight: 600; \n                          display: inline-block; box-shadow: 0 4px 10px rgba(0,0,0,0.12);\">\n                    Join Meeting\n                </a>\n            </div>\n\n            <!-- Tip Box -->\n            <div style=\"background: #f7f9fc; border-left: 3px solid #3b4a59; border-radius: 8px; padding: 14px;\">\n                <p style=\"margin: 0; font-size: 13px; color: #555; line-height: 1.4;\">\n                    Tip: Keep your details ready so your session runs smoothly.\n                </p>\n            </div>\n\n        </div>\n\n        <!-- Footer -->\n        <div style=\"background: #f1f3f6; padding: 14px; text-align: center;\">\n            <p style=\"margin: 0; font-size: 11px; color: #777;\">\n                Looking forward to connecting with you.\n            </p>\n        </div>\n\n    </div>\n\n</body>\n</html>\n",
        "options": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1360,
        1072
      ],
      "id": "7328307c-d415-4e01-8cd2-132948300ca5",
      "name": "Send a Booking email alert",
      "webhookId": "8bc0d4d6-8c1c-4bea-9f46-d46cb034971a",
      "credentials": {
        "gmailOAuth2": {
          "id": "UbWO1LFfZ6s8MzMA",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "802657959596026",
        "recipientPhoneNumber": "+918919053970",
        "textBody": "=‚ú® Namaste {{ $('Check true or false ').first().json.name2 }}! üôè\n\nüîÆ This is a gentle reminder that your astrology consultation is scheduled *tomorrow*! \n\nüìÖ *Meeting Details:*\nüïê {{ $('Check true or false ').first().json.name2 }}\n\nThe cosmic energies are aligning for our session! ‚ú®üåü\n\nüîó *Meeting Link:*\n{{$('Loop ').first().json.hangoutLink}}\n\nüí° *Quick Tip:* Keep your birth details (date, time, place) handy for an accurate reading!\n\nLooking forward to guiding you through the wisdom of the stars! üåô‚≠ê\n\n_Reply if you have any questions_ üòä",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        1184,
        864
      ],
      "id": "99d5c4ee-f2de-4279-b233-0e22c10e4646",
      "name": "Send a remainder in Whatsapp",
      "webhookId": "ee19619e-9f28-459b-a7dc-5ab34fa53e53",
      "credentials": {
        "whatsAppApi": {
          "id": "ixk5U1dBT3xISilr",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6924e89c-a091-4dce-adee-db0a6fdd4bcc",
              "name": "['attendees[1].email']",
              "value": "={{ $('Edit required fields in calender').item.json['attendees[1].email'] }}",
              "type": "string"
            },
            {
              "id": "534ce610-deb3-4fde-8178-d37b08e74ae1",
              "name": "name2",
              "value": "={{ $json.name2 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -848,
        2048
      ],
      "id": "b3ac5e68-775e-4434-b814-835c476c6f4b",
      "name": "Edit only Req Fields"
    },
    {
      "parameters": {
        "jsCode": "// Get time\nconst time = $json.time?.toLowerCase()?.trim() || \"\";\n\n// Allowed time values\nconst validTimes = [\"1hr\", \"2hrs\", \"6hrs\"];\nconst isValid = validTimes.includes(time);\n\n// Get summary\nconst summary = $json.summary || \"\";\n\n// Extract names - IMPROVED LOGIC\nlet name1 = \"\";\nlet name2 = \"\";\n\n// Try multiple patterns to handle different summary formats\nconst patterns = [\n  // \"30 Min Meeting between Lumoscale and v vamsi\"\n  /between\\s+(.+?)\\s+and\\s+(.+)/i,\n  \n  // \"Consultation with Rajesh Kumar\"\n  /with\\s+(.+)/i,\n  \n  // \"Meeting: John - Jane\"\n  /:\\s*(.+?)\\s*-\\s*(.+)/i,\n  \n  // \"Call - Vamsi Krishna\"\n  /-\\s+(.+)/i\n];\n\nfor (const pattern of patterns) {\n  const match = summary.match(pattern);\n  if (match) {\n    if (match.length === 3) {\n      // Two names found (e.g., \"between X and Y\")\n      name1 = match[1].trim();\n      name2 = match[2].trim();\n      break;\n    } else if (match.length === 2) {\n      // One name found (e.g., \"with X\")\n      name2 = match[1].trim();\n      break;\n    }\n  }\n}\n\n// If no name extracted, use a fallback\nif (!name2) {\n  name2 = \"Guest\";\n}\n\n// Return everything\nreturn [{\n  json: {\n    time,\n    isValid,\n    summary,\n    name1,\n    name2\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        1536
      ],
      "id": "4fc3af36-c7d6-4f30-a441-4ef4bcc54c4c",
      "name": "Check true or false "
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "C09PV3DSRJQ",
          "mode": "list",
          "cachedResultName": "n8n"
        },
        "text": "===========\n\nüë§ *Client:*  \n{{ $json.message.content.client_name }}\nüéØ *Core Concern:*  \n{{ $json.message.content.core_concern }}\nüß© *Real Issue:*  \n{{ $json.message.content.real_issue }}\n\nüìù *Preparation Focus:*  \n‚Ä¢ {{ $json.message.content.what_to_focus_on[0] }}  \n‚Ä¢ {{ $json.message.content.what_to_focus_on[1] }}  \n‚Ä¢ {{ $json.message.content.what_to_focus_on[2] }}\n\nüí¨ *How They Communicate:*  \n{{ $json.message.content.how_they_communicate }}\n\nüéôÔ∏è *Best Opening Approach:*  \n{{ $json.message.content.opening_approach }}\n\n‚ùì *Key Questions to Ask:*  \n1. {{ $json.message.content.questions_to_ask[0] }}  \n2. {{ $json.message.content.questions_to_ask[1] }}  \n3. {{ $json.message.content.questions_to_ask[2] }}\n\n‚ú® *What They Need:*  \n{{ $json.message.content.what_they_need }}\n\n‚ö° *Insight Edge:*  \n{{ $json.message.content.insight_edge }}\n\n===========",
        "otherOptions": {
          "includeLinkToWorkflow": false,
          "mrkdwn": false,
          "unfurl_links": false,
          "unfurl_media": false
        }
      },
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [
        384,
        2064
      ],
      "id": "fbdd9871-3977-427a-8cef-26942284ecc1",
      "name": "Send a message4",
      "webhookId": "24db3fa1-87d7-415d-81d0-5cab88ec98d6",
      "credentials": {
        "slackOAuth2Api": {
          "id": "Rb7HyhAgq0iIU3TT",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Split the Lead Snapshot into structured fields\n\nfor (const item of $input.all()) {\n\n  // FIXED FIELD NAME (must match output exactly)\n  const snapshot = item.json.leadSnapshot || \"\"; \n\n  // Extract key fields using regex\n  const name = snapshot.match(/Name:\\s*(.*?)(?=\\s*- Email|$)/i)?.[1]?.trim() || \"\";\n  const email = snapshot.match(/Email:\\s*(.*?)(?=\\s*- Date|$)/i)?.[1]?.trim() || \"\";\n  const date = snapshot.match(/Date:\\s*(.*?)(?=\\s*- Lead Stage|$)/i)?.[1]?.trim() || \"\";\n  const leadStage = snapshot.match(/Lead Stage:\\s*(.*?)(?=\\s*- Lead Score|$)/i)?.[1]?.trim() || \"\";\n  const leadScore = snapshot.match(/Lead Score:\\s*(.*?)(?=\\s*- Need Type|$)/i)?.[1]?.trim() || \"\";\n  const needType = snapshot.match(/Need Type:\\s*(.*)/i)?.[1]?.trim() || \"\";\n\n  // Add structured fields to JSON\n  item.json = {\n    ...item.json,\n    Name: name,\n    Email: email,\n    Date: date,\n    Lead_Stage: leadStage,\n    Lead_Score: leadScore,\n    Need_Type: needType\n  };\n}\n\nreturn $input.all();\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        832,
        2368
      ],
      "id": "bfeacb19-410c-4080-990b-953c6f1094ad",
      "name": "Divide Lead Details"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "messages": {
          "values": [
            {
              "content": "=You are an expert astrology consultant assistant. Create a focused Pre-Call Brief for Slack notification.\n\nThe astrologer has already studied the birth chart. Now they need to understand WHO this person is and WHAT they're really seeking before the call starts.\n\n---\n\nINPUT DATA:\nConversation History: {{ $json.conversation }}\nProblem Summary: {{ $json.problem_summary }}\nNeed Type: {{ $json.need_type }}\n\n---\n\nYOUR MISSION:\n\nAnalyze the conversation with psychological depth. Understand:\n\n1. **The Real Issue** - What's the actual problem beneath their words?\n2. **Emotional Context** - Are they desperate, curious, anxious, hopeful?\n3. **What They Need to Hear** - What will make them feel understood?\n4. **Communication Style** - How do they express themselves?\n5. **Consultation Readiness** - Are they ready to receive guidance?\n\nBe a detective. Read between the lines. Give insights that make the astrologer think \"Now I understand this person.\"\n\n---\n\nOUTPUT (JSON ONLY):\n\n{\n  \"client_name\": \"[Name]\",\n  \n  \"core_concern\": \"[Health/Career/Relationship/Money/Spiritual - in 2 words]\",\n  \n  \"real_issue\": \"[The ACTUAL problem they're facing. Not what they said, but what they mean. 1-2 sentences of deep insight.]\",\n  \n  \"emotional_state\": \"[Their current emotional energy - anxious/hopeful/desperate/curious/confused. Add why in 5-7 words.]\",\n  \n  \"what_to_focus_on\": [\n    \"[Specific house/planet/transit to examine for their issue]\",\n    \"[Second astrological focus area]\",\n    \"[Third focus if needed]\"\n  ],\n  \n  \"how_they_communicate\": \"[Their style - brief/detailed, emotional/logical, confident/hesitant. Use conversation evidence.]\",\n  \n  \"opening_approach\": \"[The EXACT first sentence to say. Make it personal. Show you understand their situation. This sets the tone for trust.]\",\n  \n  \"questions_to_ask\": [\n    \"[Question to understand deeper context]\",\n    \"[Question about timing/urgency]\",\n    \"[Question about their openness to remedies]\"\n  ],\n  \n  \"what_they_need\": \"[What will make them feel the consultation was valuable? What outcome are they hoping for?]\",\n  \n  \"insight_edge\": \"[One powerful observation from the conversation that they didn't directly state. Something that shows you really GET them. This is your secret weapon.]\"\n}\n\n---\n\nANALYSIS RULES:\n\n‚úÖ **Use Conversation Details** - Quote or reference specific things they said\n‚úÖ **Be Psychologically Insightful** - Go deeper than surface words\n‚úÖ **Be Specific** - \"Check 6th house health, Mars placement, current Saturn transit\" NOT \"analyze health\"\n‚úÖ **Be Actionable** - Everything should help deliver better guidance\n‚úÖ **Make It Personal** - Tailor everything to THIS specific person\n‚úÖ **Output Pure JSON** - No extra text before or after\n\n---\n\nCreate a brief that makes the astrologer feel: \"I know exactly who I'm talking to and what they need.\" üéØ"
            }
          ]
        },
        "jsonOutput": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        0,
        2064
      ],
      "id": "82dc8fa2-126a-445f-8a54-341f36df96a0",
      "name": "Message a model1",
      "credentials": {
        "openAiApi": {
          "id": "8cTwctTGeEBOJeUq",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -400,
        2064
      ],
      "id": "1009950a-a38e-4b6e-86ba-c6a49666decd",
      "name": "Merge"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04",
          "mode": "list",
          "cachedResultName": "Lead Qualification System",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1589942840,
          "mode": "list",
          "cachedResultName": "Convo history(insta)",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04/edit#gid=1589942840"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Email",
              "lookupValue": "={{ $json['attendees[1].email'] }}"
            },
            {
              "lookupColumn": "Name",
              "lookupValue": "={{ $json.name2 }}"
            }
          ]
        },
        "combineFilters": "OR",
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -640,
        1968
      ],
      "id": "390b2130-bae1-4d3b-bcfc-43b8b8d23d4d",
      "name": "Get convo",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3MsYFPOz6gYs3lBk",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04",
          "mode": "list",
          "cachedResultName": "Lead Qualification System",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 954419306,
          "mode": "list",
          "cachedResultName": "Instagram",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04/edit#gid=954419306"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Email",
              "lookupValue": "={{ $json['attendees[1].email'] }}"
            },
            {
              "lookupColumn": "Name",
              "lookupValue": "={{ $json.name2 }}"
            }
          ]
        },
        "combineFilters": "OR",
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -640,
        2128
      ],
      "id": "70b63423-0166-428e-86f8-e1881ab1f5cb",
      "name": "Get Instagram details",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3MsYFPOz6gYs3lBk",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04",
          "mode": "list",
          "cachedResultName": "Lead Qualification System",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 954419306,
          "mode": "list",
          "cachedResultName": "Instagram",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04/edit#gid=954419306"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Sender ID": "={{ $('Extracts ID').first().json.body.entry[0].messaging[0].sender.id }}",
            "Name": "={{ $json.Name }}",
            "Email": "={{ $json.Email }}"
          },
          "matchingColumns": [
            "Sender ID"
          ],
          "schema": [
            {
              "id": "Date",
              "displayName": "Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Name",
              "displayName": "Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Email",
              "displayName": "Email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Sender ID",
              "displayName": "Sender ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Text",
              "displayName": "Text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "problem_summary",
              "displayName": "problem_summary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "need_type",
              "displayName": "need_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "lead_score",
              "displayName": "lead_score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Lead Stage",
              "displayName": "Lead Stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "reason",
              "displayName": "reason",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "coach_notes",
              "displayName": "coach_notes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        2752,
        -144
      ],
      "id": "97e4472c-76ec-4807-809f-98db3c719fd8",
      "name": "Append or update row in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3MsYFPOz6gYs3lBk",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.output.Name && $json.output.Name.length }}",
                    "rightValue": 0,
                    "operator": {
                      "type": "number",
                      "operation": "gt"
                    },
                    "id": "fa06760f-57bc-4944-9f87-959f9c5a920f"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "083150e9-409a-40f9-89cc-a9c76f95bb3a",
                    "leftValue": "={{ $json.output.Name && $json.output.Name.length }}",
                    "rightValue": 0,
                    "operator": {
                      "type": "number",
                      "operation": "gt"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2512,
        -64
      ],
      "id": "81509475-11c0-429c-ad79-2fe0ea33f970",
      "name": "Switch"
    },
    {
      "parameters": {
        "jsCode": "const rows = $input.all();\n\n// Sort by row number\nrows.sort((a, b) => (a.json.row_number || 0) - (b.json.row_number || 0));\n\nlet blocks = [];\nlet count = 1;\n\n// Build conversation history\nfor (const r of rows) {\n  const userMsg = r.json[\"User message\"] || \"\";\n  const aiReply = r.json[\"AI reply\"] || \"\";\n\n  if (userMsg.trim() !== \"\" || aiReply.trim() !== \"\") {\n    const block = \n`${count}.\nUser: ${userMsg}\nAI: ${aiReply}\n`;\n    blocks.push(block);\n    count++;\n  }\n}\n\n// Find Instagram detail row (has \"Text\" field)\nconst detailRow = rows.find(r => r.json.Text !== undefined)?.json || {};\n\n// Output\nreturn [\n  {\n    json: {\n      conversation: blocks.join(\"\\n\"),\n\n      incoming_text: detailRow.Text || \"\",\n      problem_summary: detailRow.problem_summary || \"\",\n      need_type: detailRow.need_type || \"\",\n      lead_score: detailRow.lead_score || \"\",\n      lead_stage: detailRow[\"Lead Stage\"] || \"\",\n      reason: detailRow.reason || \"\",\n      coach_notes: detailRow.coach_notes || \"\"\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -192,
        2064
      ],
      "id": "a7d5b220-ac61-44e1-975c-7f40ffe931fe",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Extracts ID').first().json.body.entry[0].messaging[0].sender.id }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        1296,
        384
      ],
      "id": "a1145f6f-6772-4d9d-b763-0dc35b7c8ae6",
      "name": "Simple Memory1"
    },
    {
      "parameters": {
        "jsCode": "const rows = $input.all();\n\n// Sort by row number\nrows.sort((a, b) => (a.json.row_number || 0) - (b.json.row_number || 0));\n\nlet blocks = [];\nlet count = 1;\n\n// Build conversation history\nfor (const r of rows) {\n  const userMsg = r.json[\"User message\"] || \"\";\n  const aiReply = r.json[\"AI reply\"] || \"\";\n\n  if (userMsg.trim() !== \"\" || aiReply.trim() !== \"\") {\n    const block = \n`${count}.\nUser: ${userMsg}\nAI: ${aiReply}\n`;\n    blocks.push(block);\n    count++;\n  }\n}\n\n// Find Instagram detail row (has \"Text\" field)\nconst detailRow = rows.find(r => r.json.Text !== undefined)?.json || {};\n\n// Output\nreturn [\n  {\n    json: {\n      conversation: blocks.join(\"\\n\"),\n\n      incoming_text: detailRow.Text || \"\",\n      problem_summary: detailRow.problem_summary || \"\",\n      need_type: detailRow.need_type || \"\",\n      lead_score: detailRow.lead_score || \"\",\n      lead_stage: detailRow[\"Lead Stage\"] || \"\",\n      reason: detailRow.reason || \"\",\n      coach_notes: detailRow.coach_notes || \"\"\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        352,
        2288
      ],
      "id": "d5445c7d-9bd5-4038-8600-816f2303958a",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "sendTo": "={{ $('Edit required fields in calender').first().json['attendees[1].email'] }}",
        "subject": "=Remainder bro",
        "message": "=<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <title>Meeting Reminder</title>\n</head>\n<body style=\"margin: 0; padding: 0; background-color: #F4F6F8; font-family: Arial, sans-serif;\">\n\n  <table align=\"center\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"padding: 30px 0;\">\n    <tr>\n      <td align=\"center\">\n        \n        <!-- Card Container -->\n        <table width=\"500\" cellpadding=\"0\" cellspacing=\"0\" \n          style=\"background: #FFFFFF; border-radius: 14px; box-shadow: 0 8px 25px rgba(0,0,0,0.12); padding: 0;\">\n\n          <!-- Header Section -->\n          <tr>\n            <td style=\"background: linear-gradient(135deg,#3B82F6,#2563EB); padding: 30px 20px; border-radius: 14px 14px 0 0; text-align: center;\">\n              <h2 style=\"margin: 0; color: #FFFFFF; font-size: 24px; font-weight: bold;\">\n                Upcoming Meeting Reminder\n              </h2>\n            </td>\n          </tr>\n\n          <!-- Body Content -->\n          <tr>\n            <td style=\"padding: 25px 30px; color: #333333;\">\n              \n              <p style=\"margin: 0 0 15px; font-size: 16px;\">\n                Hi <strong>{{NAME}}</strong>,\n              </p>\n\n              <p style=\"margin: 0 0 20px; font-size: 15px; line-height: 1.6;\">\n                {{SHORT_NOTE}}\n              </p>\n\n              <!-- Meeting Details Box -->\n              <table width=\"100%\" style=\"background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 10px; padding: 15px;\">\n                <tr>\n                  <td style=\"padding: 10px 5px; font-size: 14px;\">\n                    <strong style=\"color: #111827;\">Date & Time:</strong><br>\n                    <span style=\"color: #374151;\">{{MEETING_TIME}}</span>\n                  </td>\n                </tr>\n                <tr>\n                  <td style=\"padding: 10px 5px; font-size: 14px;\">\n                    <strong style=\"color: #111827;\">Session Type:</strong><br>\n                    <span style=\"color: #374151;\">Astrology consultation call</span>\n                  </td>\n                </tr>\n              </table>\n\n              <!-- CTA Button -->\n              <div style=\"text-align: center; margin: 30px 0 10px;\">\n                <a href=\"{{MEETING_LINK}}\" \n                  style=\"display: inline-block; background: #2563EB; color: #FFFFFF; padding: 14px 28px; border-radius: 8px; \n                  text-decoration: none; font-size: 16px; font-weight: bold;\">\n                  Join Meeting\n                </a>\n              </div>\n\n            </td>\n          </tr>\n\n          <!-- Footer -->\n          <tr>\n            <td style=\"text-align: center; padding: 18px; font-size: 13px; color: #6B7280;\">\n              Looking forward to speaking with you.\n            </td>\n          </tr>\n\n        </table>\n\n      </td>\n    </tr>\n  </table>\n\n</body>\n</html>\n",
        "options": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1376,
        1456
      ],
      "id": "57a4d2fd-97ec-4f1c-bbca-87249a2f65c5",
      "name": "Send a Booking email alert1",
      "webhookId": "8bc0d4d6-8c1c-4bea-9f46-d46cb034971a",
      "credentials": {
        "gmailOAuth2": {
          "id": "UbWO1LFfZ6s8MzMA",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "802657959596026",
        "recipientPhoneNumber": "+918919053970",
        "textBody": "Hello",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        1376,
        1296
      ],
      "id": "2b90fc64-a021-49a6-80d0-4b7118c3d7a4",
      "name": "Send a remainder in Whatsapp1",
      "webhookId": "ee19619e-9f28-459b-a7dc-5ab34fa53e53",
      "credentials": {
        "whatsAppApi": {
          "id": "ixk5U1dBT3xISilr",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "={{ $('Edit required fields in calender').first().json['attendees[1].email'] }}",
        "subject": "=Remainder bro",
        "message": "=<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <title>Meeting Reminder</title>\n</head>\n<body style=\"margin: 0; padding: 0; background-color: #F4F6F8; font-family: Arial, sans-serif;\">\n\n  <table align=\"center\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"padding: 30px 0;\">\n    <tr>\n      <td align=\"center\">\n        \n        <!-- Card Container -->\n        <table width=\"500\" cellpadding=\"0\" cellspacing=\"0\" \n          style=\"background: #FFFFFF; border-radius: 14px; box-shadow: 0 8px 25px rgba(0,0,0,0.12); padding: 0;\">\n\n          <!-- Header Section -->\n          <tr>\n            <td style=\"background: linear-gradient(135deg,#3B82F6,#2563EB); padding: 30px 20px; border-radius: 14px 14px 0 0; text-align: center;\">\n              <h2 style=\"margin: 0; color: #FFFFFF; font-size: 24px; font-weight: bold;\">\n                Upcoming Meeting Reminder\n              </h2>\n            </td>\n          </tr>\n\n          <!-- Body Content -->\n          <tr>\n            <td style=\"padding: 25px 30px; color: #333333;\">\n              \n              <p style=\"margin: 0 0 15px; font-size: 16px;\">\n                Hi <strong>{{NAME}}</strong>,\n              </p>\n\n              <p style=\"margin: 0 0 20px; font-size: 15px; line-height: 1.6;\">\n                {{SHORT_NOTE}}\n              </p>\n\n              <!-- Meeting Details Box -->\n              <table width=\"100%\" style=\"background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 10px; padding: 15px;\">\n                <tr>\n                  <td style=\"padding: 10px 5px; font-size: 14px;\">\n                    <strong style=\"color: #111827;\">Date & Time:</strong><br>\n                    <span style=\"color: #374151;\">{{MEETING_TIME}}</span>\n                  </td>\n                </tr>\n                <tr>\n                  <td style=\"padding: 10px 5px; font-size: 14px;\">\n                    <strong style=\"color: #111827;\">Session Type:</strong><br>\n                    <span style=\"color: #374151;\">Astrology consultation call</span>\n                  </td>\n                </tr>\n              </table>\n\n              <!-- CTA Button -->\n              <div style=\"text-align: center; margin: 30px 0 10px;\">\n                <a href=\"{{MEETING_LINK}}\" \n                  style=\"display: inline-block; background: #2563EB; color: #FFFFFF; padding: 14px 28px; border-radius: 8px; \n                  text-decoration: none; font-size: 16px; font-weight: bold;\">\n                  Join Meeting\n                </a>\n              </div>\n\n            </td>\n          </tr>\n\n          <!-- Footer -->\n          <tr>\n            <td style=\"text-align: center; padding: 18px; font-size: 13px; color: #6B7280;\">\n              Looking forward to speaking with you.\n            </td>\n          </tr>\n\n        </table>\n\n      </td>\n    </tr>\n  </table>\n\n</body>\n</html>\n",
        "options": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1360,
        1824
      ],
      "id": "2a46c042-c6f8-4705-9c04-8e34aa7a3b7e",
      "name": "Send a Booking email alert2",
      "webhookId": "8bc0d4d6-8c1c-4bea-9f46-d46cb034971a",
      "credentials": {
        "gmailOAuth2": {
          "id": "UbWO1LFfZ6s8MzMA",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "802657959596026",
        "recipientPhoneNumber": "+918919053970",
        "textBody": "Hello",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        1376,
        1664
      ],
      "id": "eefffc6f-51d0-474d-80cd-09170770ffb6",
      "name": "Send a remainder in Whatsapp2",
      "webhookId": "ee19619e-9f28-459b-a7dc-5ab34fa53e53",
      "credentials": {
        "whatsAppApi": {
          "id": "ixk5U1dBT3xISilr",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "events": [
          "BOOKING_CANCELLED",
          "BOOKING_CREATED",
          "BOOKING_RESCHEDULED",
          "MEETING_ENDED"
        ],
        "options": {}
      },
      "type": "n8n-nodes-base.calTrigger",
      "typeVersion": 2,
      "position": [
        3952,
        -144
      ],
      "id": "e7d94dc7-c1e2-4d87-8c18-65d8990d8215",
      "name": "Cal.com Trigger",
      "webhookId": "4077afa7-b88e-45f0-827c-1355baad3620",
      "credentials": {
        "calApi": {
          "id": "EUv3ewUXAb0GzLlV",
          "name": "Vamsi Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "79f66929-3483-41f2-accf-f14f991d5807",
              "name": "Client Name",
              "value": "={{ $json.attendees[0].name }}",
              "type": "string"
            },
            {
              "id": "319f561a-db86-4d4d-aed3-ee06eca6bfde",
              "name": "Client Email",
              "value": "={{ $json.attendees[0].email }}",
              "type": "string"
            },
            {
              "id": "353926b3-9490-43b1-b63d-6197d32db4cf",
              "name": "Website",
              "value": "={{ $json.responses.Website_name.value }}",
              "type": "string"
            },
            {
              "id": "d862683c-be74-4c7c-9790-5cdb58ba6220",
              "name": "Url",
              "value": "={{ $json.responses.URL.value }}",
              "type": "string"
            },
            {
              "id": "df7749a7-d034-4813-b44a-18b06d749935",
              "name": "Notes",
              "value": "={{ $json.responses.notes.value }}",
              "type": "string"
            },
            {
              "id": "24e1393c-aa1b-4ed4-9d80-0b6c324e074d",
              "name": "startTime",
              "value": "={{ new Date($json.startTime).toLocaleString(\"en-IN\", { timeZone: \"Asia/Kolkata\" }) }}",
              "type": "string"
            },
            {
              "id": "b3c3df5d-8bc8-4c6b-92eb-0bee8a5ecc0d",
              "name": "metadata.videoCallUrl",
              "value": "={{ $json.metadata.videoCallUrl }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4144,
        -144
      ],
      "id": "9d071abc-ca2d-4f88-9166-37c5f4930a39",
      "name": "Required Fields"
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "C09PV3DSRJQ",
          "mode": "list",
          "cachedResultName": "n8n"
        },
        "text": "===========\n\nüìÖ *New Meeting Booked*\n\nüë§ *Name:* {{ $json.Name }}\nüìß *Email:* {{ $json.Email }}\nüóìÔ∏è *Date:* {{ $json.Date }}\n\nüìù *Problem:* {{ $json.problem_summary }}\nüéØ *Need Type:* {{ $json.need_type }}\nüí¨ *Reason:* {{ $json.reason }}\n\n==========\n",
        "otherOptions": {}
      },
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [
        4816,
        -144
      ],
      "id": "4ae9ed29-8b50-4e34-a542-cb05cc3d964c",
      "name": "Send a message3",
      "webhookId": "95ccdc9a-7d9f-4f63-a865-21013837b776",
      "credentials": {
        "slackOAuth2Api": {
          "id": "Rb7HyhAgq0iIU3TT",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Cal.com Trigger').item.json.triggerEvent }}",
                    "rightValue": "BOOKING_CREATED",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "8d9c1f1c-fef0-4a3a-b031-be8319db02ef"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "BOOKING_CREATED"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        4368,
        -144
      ],
      "id": "c6877bba-7deb-45e1-90b4-a39a0a0ddb29",
      "name": "Switch1"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04",
          "mode": "list",
          "cachedResultName": "Lead Qualification System",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 954419306,
          "mode": "list",
          "cachedResultName": "Instagram",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1IUNIvKOc2s6qmjwrMZLpuhgvvK_py2sXskapsOswS04/edit#gid=954419306"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "Email",
              "lookupValue": "={{ $json['Client Email'] }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4592,
        -144
      ],
      "id": "e864aad7-3af6-434e-88ae-bff9df231473",
      "name": "Get row(s) in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "3MsYFPOz6gYs3lBk",
          "name": "Google Sheets account"
        }
      }
    }
  ],
  "connections": {
    "AI Agent": {
      "main": [
        [
          {
            "node": "Format Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extracts ID": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [],
        [
          {
            "node": "Get previous convo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Extract info",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Get last 5 Conversations": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get previous convo": {
      "main": [
        [
          {
            "node": "Get last 5 Conversations",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Prompt": {
      "main": [
        [
          {
            "node": "Detect lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detect lead": {
      "main": [
        [
          {
            "node": "Extract info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract info": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          },
          {
            "node": "Extract Data from prev node",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Data from prev node": {
      "main": [
        [
          {
            "node": "Add conversations to sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add rows to sheet1": {
      "main": [
        [
          {
            "node": "Send reply back in Instagram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Add conversations to sheet": {
      "main": [
        [
          {
            "node": "Add rows to sheet1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram DM": {
      "main": [
        [
          {
            "node": "Extracts ID",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Checks every 30min": {
      "main": [
        [
          {
            "node": "Get All Meetings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get All Meetings": {
      "main": [
        [
          {
            "node": "Split out all Meetings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split out all Meetings": {
      "main": [
        [
          {
            "node": "Edit start and end time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit start and end time": {
      "main": [
        [
          {
            "node": "Loop ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop ": {
      "main": [
        [],
        [
          {
            "node": "Checks the time diff ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Checks the time diff ": {
      "main": [
        [
          {
            "node": "Edit required fields in calender",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit required fields in calender": {
      "main": [
        [
          {
            "node": "Check true or false ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch btw hrs": {
      "main": [
        [
          {
            "node": "Loop ",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send a remainder in Whatsapp",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop ",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send a remainder in Whatsapp1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send a Booking email alert1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop ",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send a remainder in Whatsapp2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send a Booking email alert2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit only Req Fields",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send a Booking email alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit only Req Fields": {
      "main": [
        [
          {
            "node": "Get convo",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Instagram details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check true or false ": {
      "main": [
        [
          {
            "node": "Switch btw hrs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Divide Lead Details": {
      "main": [
        []
      ]
    },
    "Message a model1": {
      "main": [
        [
          {
            "node": "Send a message4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get convo": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Instagram details": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Append or update row in sheet",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Message a model1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory1": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Cal.com Trigger": {
      "main": [
        [
          {
            "node": "Required Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Required Fields": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet": {
      "main": [
        [
          {
            "node": "Send a message3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a message4": {
      "main": [
        []
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": {
    "node:Checks every 30min": {
      "recurrenceRules": []
    },
    "node:Cal.com Trigger": {
      "webhookId": "a999b8e8-3205-43ee-adef-7a369e8291ae"
    }
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Instagram DM": [
      {
        "json": {
          "headers": {
            "host": "n8n.srv1011051.hstgr.cloud",
            "user-agent": "facebookexternalua",
            "content-length": "392",
            "accept": "*/*",
            "accept-encoding": "deflate, gzip",
            "content-type": "application/json",
            "instagram-api-version": "v24.0",
            "x-forwarded-for": "172.18.0.1",
            "x-forwarded-host": "n8n.srv1011051.hstgr.cloud",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "91aa74ac8129",
            "x-hub-signature": "sha1=1b12bf407326c6c9a06ffa8145579986dec3fedc",
            "x-hub-signature-256": "sha256=485bf5324d1dd76690a2ba808b22a80dceef313834ec996008d70ad03aef1ac0",
            "x-real-ip": "172.18.0.1"
          },
          "params": {},
          "query": {},
          "body": {
            "object": "instagram",
            "entry": [
              {
                "time": 1765465051029,
                "id": "17841467996117515",
                "messaging": [
                  {
                    "sender": {
                      "id": "785204224427426"
                    },
                    "recipient": {
                      "id": "17841467996117515"
                    },
                    "timestamp": 1765465050677,
                    "message": {
                      "mid": "aWdfZAG1faXRlbToxOklHTWVzc2FnZAUlEOjE3ODQxNDY3OTk2MTE3NTE1OjM0MDI4MjM2Njg0MTcxMDMwMTI0NDI1OTY2MzAwMzQ3OTY4MzQ3NTozMjU2NzA4MTk2MDkxOTQwNDM0MjY4ODg2Mzg0MjQ2Nzg0MAZDZD",
                      "text": "Hi"
                    }
                  }
                ]
              }
            ]
          },
          "webhookUrl": "https://n8n.srv1011051.hstgr.cloud/webhook-test/instagram",
          "executionMode": "test"
        }
      }
    ],
    "Edit only Req Fields": [
      {
        "json": {
          "attendees[1].email": "vamsikrishna2536@gmail.com",
          "name2": "v vamsi"
        }
      }
    ],
    "Get convo": [
      {
        "json": {
          "row_number": 2,
          "Sender_id": 785204224427426,
          "Name": "Vamsi",
          "Email": "vamsikrishna2536@gmail.com",
          "AI reply": "Hey! Thanks for reaching out üòä Hope you're doing well - what's on your mind?",
          "User message": "Hello"
        }
      },
      {
        "json": {
          "row_number": 3,
          "Sender_id": 785204224427426,
          "Name": "Vamsi",
          "Email": "vamsikrishna2536@gmail.com",
          "AI reply": "Hey! Thanks for reaching out üôè Hope you're doing well - what's on your mind?",
          "User message": "Hello"
        }
      },
      {
        "json": {
          "row_number": 4,
          "Sender_id": 785204224427426,
          "Name": "Vamsi",
          "Email": "vamsikrishna2536@gmail.com",
          "AI reply": "Hey! We mainly do in-depth astrology consultations where Guruji studies your full birth chart, gives predictions, and suggests remedies to help. Btw, what should I call you? üòä",
          "User message": "What are your services"
        }
      },
      {
        "json": {
          "row_number": 5,
          "Sender_id": 785204224427426,
          "Name": "Vamsi",
          "Email": "vamsikrishna2536@gmail.com",
          "AI reply": "Hey Vamsi! üôè So like I mentioned, Guruji does deep astrology readings based on your full birth chart‚Äîgives predictions and remedies to help with stuff like career, relationships, health, and more. Anything specific you're curious about?",
          "User message": "Vamsi"
        }
      },
      {
        "json": {
          "row_number": 6,
          "Sender_id": 785204224427426,
          "Name": "Vamsi",
          "Email": "vamsikrishna2536@gmail.com",
          "AI reply": "Hey Vamsi! üôè Health stuff can really weigh on you. Anything specific troubling you lately, or just want to understand what‚Äôs coming up in general?",
          "User message": "Health"
        }
      }
    ],
    "Get Instagram details": [
      {
        "json": {
          "row_number": 4,
          "Date": "12/11/2025",
          "Name": "Vamsi",
          "Email": "vamsikrishna2536@gmail.com",
          "Sender ID": 785204224427426,
          "Text": "Health",
          "problem_summary": "Interested in astrology guidance related to health concerns",
          "need_type": "Health",
          "lead_score": "",
          "Lead Stage": "Warm",
          "reason": "User shared health concern showing curiosity but no urgency or direct booking intent",
          "coach_notes": "User focused on health; needs gentle probing to understand exact concern"
        }
      }
    ],
    "Cal.com Trigger": [
      {
        "json": {
          "triggerEvent": "BOOKING_CREATED",
          "createdAt": "2025-12-11T20:21:32.941Z",
          "bookerUrl": "https://cal.com",
          "title": "30 Min Meeting between Lumoscale and v vamsi",
          "startTime": "2025-12-12T16:00:00Z",
          "endTime": "2025-12-12T16:30:00Z",
          "additionalNotes": "",
          "type": "30min",
          "description": "let‚Äôs chat and explore ideas",
          "eventTypeId": 3086845,
          "hideCalendarNotes": false,
          "hideCalendarEventDetails": false,
          "hideOrganizerEmail": false,
          "schedulingType": null,
          "seatsPerTimeSlot": null,
          "seatsShowAttendees": true,
          "seatsShowAvailabilityCount": true,
          "customReplyToEmail": null,
          "disableRescheduling": false,
          "disableCancelling": false,
          "organizer": {
            "id": 1696057,
            "name": "Lumoscale",
            "email": "vamsivk1465@gmail.com",
            "username": "vamsivk",
            "timeZone": "Asia/Calcutta",
            "language": {
              "locale": "en"
            },
            "timeFormat": "HH:mm",
            "utcOffset": 330
          },
          "attendees": [
            {
              "email": "vamsikrishna2536@gmail.com",
              "name": "v vamsi",
              "firstName": "",
              "lastName": "",
              "timeZone": "Asia/Calcutta",
              "language": {
                "locale": "en"
              },
              "utcOffset": 330
            }
          ],
          "customInputs": {},
          "responses": {
            "name": {
              "label": "your_name",
              "value": "v vamsi",
              "isHidden": false
            },
            "email": {
              "label": "email_address",
              "value": "vamsikrishna2536@gmail.com",
              "isHidden": false
            },
            "attendeePhoneNumber": {
              "label": "phone_number",
              "isHidden": true
            },
            "location": {
              "label": "location",
              "value": {
                "value": "integrations:google:meet",
                "optionValue": ""
              },
              "isHidden": false
            },
            "Company-name": {
              "label": "Company name",
              "isHidden": false
            },
            "Linkedin-website-instagram": {
              "label": "Linkedin or website or Instagram",
              "isHidden": false
            },
            "title": {
              "label": "what_is_this_meeting_about",
              "value": "NA",
              "isHidden": false
            },
            "notes": {
              "label": "additional_notes",
              "isHidden": true
            },
            "guests": {
              "label": "additional_guests",
              "value": [],
              "isHidden": false
            },
            "rescheduleReason": {
              "label": "reason_for_reschedule",
              "isHidden": false
            }
          },
          "userFieldsResponses": {
            "Company-name": {
              "label": "Company name",
              "isHidden": false
            },
            "Linkedin-website-instagram": {
              "label": "Linkedin or website or Instagram",
              "isHidden": false
            }
          },
          "location": "integrations:google:meet",
          "destinationCalendar": [
            {
              "id": 759961,
              "integration": "google_calendar",
              "externalId": "vamsivk1465@gmail.com",
              "primaryEmail": "vamsivk1465@gmail.com",
              "userId": 1696057,
              "eventTypeId": null,
              "credentialId": 1245761,
              "createdAt": "2025-08-17T16:26:13.617Z",
              "updatedAt": "2025-10-26T15:39:26.010Z",
              "delegationCredentialId": null,
              "domainWideDelegationCredentialId": null
            }
          ],
          "iCalUID": "n6TsDDq89XE5BpJrSrPDiP@Cal.com",
          "iCalSequence": 0,
          "requiresConfirmation": false,
          "oneTimePassword": null,
          "hashedLink": null,
          "uid": "n6TsDDq89XE5BpJrSrPDiP",
          "conferenceData": {
            "createRequest": {
              "requestId": "8a0ce172-f69a-51b5-8481-93feb73d58e2"
            }
          },
          "appsStatus": [
            {
              "appName": "google-calendar",
              "type": "google_calendar",
              "success": 1,
              "failures": 0,
              "errors": [],
              "warnings": []
            },
            {
              "appName": "Google Meet",
              "type": "conferencing",
              "success": 1,
              "failures": 0,
              "errors": []
            }
          ],
          "eventTitle": "30 Min Meeting",
          "eventDescription": "let‚Äôs chat and explore ideas",
          "price": 0,
          "currency": "usd",
          "length": 30,
          "bookingId": 13702231,
          "metadata": {
            "videoCallUrl": "https://meet.google.com/ocz-jrjk-qaq"
          },
          "status": "ACCEPTED"
        }
      }
    ],
    "Merge": [
      {
        "json": {
          "row_number": 2,
          "Sender_id": 785204224427426,
          "Name": "Vamsi",
          "Email": "vamsikrishna2536@gmail.com",
          "AI reply": "Hey! Thanks for reaching out üòä Hope you're doing well - what's on your mind?",
          "User message": "Hello"
        }
      },
      {
        "json": {
          "row_number": 3,
          "Sender_id": 785204224427426,
          "Name": "Vamsi",
          "Email": "vamsikrishna2536@gmail.com",
          "AI reply": "Hey! Thanks for reaching out üôè Hope you're doing well - what's on your mind?",
          "User message": "Hello"
        }
      },
      {
        "json": {
          "row_number": 4,
          "Sender_id": 785204224427426,
          "Name": "Vamsi",
          "Email": "vamsikrishna2536@gmail.com",
          "AI reply": "Hey! We mainly do in-depth astrology consultations where Guruji studies your full birth chart, gives predictions, and suggests remedies to help. Btw, what should I call you? üòä",
          "User message": "What are your services"
        }
      },
      {
        "json": {
          "row_number": 5,
          "Sender_id": 785204224427426,
          "Name": "Vamsi",
          "Email": "vamsikrishna2536@gmail.com",
          "AI reply": "Hey Vamsi! üôè So like I mentioned, Guruji does deep astrology readings based on your full birth chart‚Äîgives predictions and remedies to help with stuff like career, relationships, health, and more. Anything specific you're curious about?",
          "User message": "Vamsi"
        }
      },
      {
        "json": {
          "row_number": 6,
          "Sender_id": 785204224427426,
          "Name": "Vamsi",
          "Email": "vamsikrishna2536@gmail.com",
          "AI reply": "Hey Vamsi! üôè Health stuff can really weigh on you. Anything specific troubling you lately, or just want to understand what‚Äôs coming up in general?",
          "User message": "Health"
        }
      },
      {
        "json": {
          "row_number": 4,
          "Date": "12/11/2025",
          "Name": "Vamsi",
          "Email": "vamsikrishna2536@gmail.com",
          "Sender ID": 785204224427426,
          "Text": "Health",
          "problem_summary": "Interested in astrology guidance related to health concerns",
          "need_type": "Health",
          "lead_score": "",
          "Lead Stage": "Warm",
          "reason": "User shared health concern showing curiosity but no urgency or direct booking intent",
          "coach_notes": "User focused on health; needs gentle probing to understand exact concern"
        }
      }
    ],
    "Code in JavaScript1": [
      {
        "json": {
          "conversation": "1.\nUser: Hello\nAI: Hey! Thanks for reaching out üòä Hope you're doing well - what's on your mind?\n\n2.\nUser: Hello\nAI: Hey! Thanks for reaching out üôè Hope you're doing well - what's on your mind?\n\n3.\nUser: What are your services\nAI: Hey! We mainly do in-depth astrology consultations where Guruji studies your full birth chart, gives predictions, and suggests remedies to help. Btw, what should I call you? üòä\n\n4.\nUser: Vamsi\nAI: Hey Vamsi! üôè So like I mentioned, Guruji does deep astrology readings based on your full birth chart‚Äîgives predictions and remedies to help with stuff like career, relationships, health, and more. Anything specific you're curious about?\n\n5.\nUser: Health\nAI: Hey Vamsi! üôè Health stuff can really weigh on you. Anything specific troubling you lately, or just want to understand what‚Äôs coming up in general?\n",
          "incoming_text": "Health",
          "problem_summary": "Interested in astrology guidance related to health concerns",
          "need_type": "Health",
          "lead_score": "",
          "lead_stage": "Warm",
          "reason": "User shared health concern showing curiosity but no urgency or direct booking intent",
          "coach_notes": "User focused on health; needs gentle probing to understand exact concern"
        }
      }
    ],
    "Message a model1": [
      {
        "json": {
          "index": 0,
          "message": {
            "role": "assistant",
            "content": {
              "client_name": "Vamsi",
              "core_concern": "Health Guidance",
              "real_issue": "Vamsi is likely dealing with ongoing health concerns causing anxiety or stress, seeking both predictive insight and practical guidance.",
              "emotional_state": "Anxious and curious about future health.",
              "what_to_focus_on": [
                "6th house for health issues",
                "Mars for energy and vitality",
                "Saturn's current transits for chronic conditions"
              ],
              "how_they_communicate": "Brief and somewhat hesitant; they need careful guidance.",
              "opening_approach": "Hi Vamsi, I understand that health concerns are on your mind, and I'm here to help clarify and guide you.",
              "questions_to_ask": [
                "Can you share a bit more about your current health concerns?",
                "Is there any urgency regarding health issues you're facing?",
                "Are you open to incorporating specific remedies or lifestyle changes for better health?"
              ],
              "what_they_need": "Clarity on health-related predictions and actionable remedies to alleviate anxiety and promote well-being.",
              "insight_edge": "Vamsi's outreach for health guidance at the start hints at underlying anxiety and the desire for reassurance and proactive steps."
            },
            "refusal": null,
            "annotations": []
          },
          "logprobs": null,
          "finish_reason": "stop"
        }
      }
    ]
  },
  "versionId": "22209d48-6d19-4e52-9e19-cd3af67a7bcd",
  "triggerCount": 3,
  "shared": [
    {
      "createdAt": "2025-12-10T18:58:23.857Z",
      "updatedAt": "2025-12-10T18:58:23.857Z",
      "role": "workflow:owner",
      "workflowId": "Y3vTm07Rfyh5CmwB",
      "projectId": "VDyoKZWt3i5eAZSO"
    }
  ],
  "tags": []
}